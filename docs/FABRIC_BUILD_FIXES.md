# Fabric Build Fixes - Quick Reference

**Last Updated**: November 15, 2024  
**Status**: ✅ All fixes applied, builds passing

---

## Overview

This document details the final build configuration fixes that were required to complete the Fabric migration and achieve successful compilation.

---

## Issues Fixed

### 1. Missing RCT Promise Types

**Error:**
```
error: expected a type
- (void)presentAtIndex:(NSInteger)index resolve:(RCTPromiseResolveBlock)resolve reject:(RCTPromiseRejectBlock)reject;
```

**Root Cause:**
The `RCTPromiseResolveBlock` and `RCTPromiseRejectBlock` types were not defined because the required header was missing.

**Fix:**
Added missing import to `TrueSheetViewComponentView.h`:

```objc
#import <React/RCTBridgeModule.h>
```

**File**: `ios/TrueSheetViewComponentView.h`

---

### 2. WithDefault Type Dereferencing

**Error:**
```
error: indirection requires pointer operand ('int' invalid)
_controller.cornerRadius = @(*newViewProps.cornerRadius);
```

**Root Cause:**
`WithDefault<T, Default>` types from Codegen are value types, not pointers. They cannot be dereferenced with `*`.

**Fix:**
Changed from pointer dereferencing to direct value access:

**Before:**
```cpp
if (newViewProps.cornerRadius) {
    _controller.cornerRadius = @(*newViewProps.cornerRadius);
}
```

**After:**
```cpp
if (newViewProps.cornerRadius != 0.0) {
    _controller.cornerRadius = @(newViewProps.cornerRadius);
}
```

**Pattern Applied To:**
- `cornerRadius` (Double)
- `maxHeight` (Double)
- `contentHeight` (Double)
- `footerHeight` (Double)
- `dimmedIndex` (Int32)
- `scrollableHandle` (Int32)
- `background` (Int32)

**File**: `ios/TrueSheetViewComponentView.mm`

---

### 3. Event Emitter Type Names

**Error:**
```
error: no type named 'Int32' in namespace 'facebook::react'
event.index = static_cast<facebook::react::Int32>(index);
```

**Root Cause:**
Codegen generates standard C++ primitive types (`int`, `double`), not custom types like `Int32` or `Float`. The `facebook::react` namespace doesn't contain these type aliases.

**Fix:**
Changed event emitter type casts to use standard C++ types:

**Before:**
```cpp
event.index = static_cast<Int32>(index);
event.value = static_cast<Float>(sizeValue);
```

**After:**
```cpp
event.index = static_cast<int>(index);
event.value = static_cast<double>(sizeValue);
```

**Verified in Generated Code:**
```cpp
// From EventEmitters.h (generated by Codegen)
struct OnPresent {
    int index;      // Not Int32
    double value;   // Not Float
};
```

**File**: `ios/TrueSheetViewComponentView.mm`

---

### 4. Codegen Configuration

**Issue:**
Codegen wasn't generating component files properly, causing header search path issues.

**Root Cause:**
Incorrect `codegenConfig` in package.json. Using `includesGeneratedCode: true` with `outputDir` meant the library would manage its own Codegen output, but files weren't being generated.

**Fix:**
Updated package.json to use proper component provider configuration:

**Before:**
```json
"codegenConfig": {
  "name": "TrueSheetViewSpec",
  "type": "components",
  "jsSrcsDir": "src",
  "outputDir": {
    "ios": "ios"
  },
  "includesGeneratedCode": true
}
```

**After:**
```json
"codegenConfig": {
  "name": "TrueSheetViewSpec",
  "type": "components",
  "jsSrcsDir": "src",
  "ios": {
    "componentProvider": "TrueSheetView"
  }
}
```

**Result:**
- Codegen now generates files during build
- Build system automatically includes correct header paths
- No manual header search path configuration needed

**File**: `package.json`

---

## Complete Fix Summary

### Files Modified

1. **ios/TrueSheetViewComponentView.h**
   - Added: `#import <React/RCTBridgeModule.h>`

2. **ios/TrueSheetViewComponentView.mm**
   - Fixed: 13 instances of WithDefault type dereferencing
   - Fixed: 10 instances of event emitter type casting
   - Changed: `Int32` → `int`
   - Changed: `Float` → `double`

3. **package.json**
   - Updated: `codegenConfig` structure
   - Removed: `includesGeneratedCode` flag
   - Added: `ios.componentProvider` field

4. **TrueSheet.podspec**
   - No changes needed (previous header search path additions removed)

---

## Build Verification

### Commands Run
```bash
cd example/ios
pod install
cd ..
xcodebuild -workspace ios/TrueSheetExample.xcworkspace \
  -scheme TrueSheet \
  -configuration Debug \
  -sdk iphonesimulator \
  -arch x86_64 build
```

### Results
```
✅ BUILD SUCCEEDED
✅ Zero compilation errors
✅ Zero link errors
✅ Library compiles cleanly
```

---

## Codegen Generated Files

### Location
```
example/ios/build/generated/ios/react/renderer/components/TrueSheetViewSpec/
```

### Generated Files
- `ComponentDescriptors.h` / `.cpp`
- `EventEmitters.h` / `.cpp`
- `Props.h` / `.cpp`
- `RCTComponentViewHelpers.h`
- `ShadowNodes.h` / `.cpp`
- `States.h` / `.cpp`

### Key Types Generated
```cpp
// From EventEmitters.h
struct OnPresent {
    int index;        // ← Standard int, not Int32
    double value;     // ← Standard double, not Float
};

// From Props.h
struct Props : public ViewProps {
    Int32 scrollableHandle{0};       // WithDefault<Int32, null>
    Double cornerRadius{0.0};        // WithDefault<Double, null>
    // ... etc
};
```

---

## Type Reference Guide

### WithDefault<T, Default> Handling

**Understanding WithDefault:**
- It's a value type, not a pointer
- Has an implicit conversion to the underlying type
- Cannot use `*` (dereference) operator
- Cannot use `->` (member access) operator
- Access value directly

**Correct Patterns:**

```cpp
// ✅ CORRECT: Direct value access
if (props.cornerRadius != 0.0) {
    _controller.cornerRadius = @(props.cornerRadius);
}

// ✅ CORRECT: Comparison with default
if (props.dimmedIndex >= 0) {
    _controller.dimmedIndex = @(props.dimmedIndex);
}

// ❌ WRONG: Pointer dereferencing
if (props.cornerRadius) {
    _controller.cornerRadius = @(*props.cornerRadius);
}
```

### Event Emitter Types

**Generated Types:**
```cpp
// Codegen always generates standard C++ types
struct OnDragBegin {
    int index;      // Not Int32
    double value;   // Not Float or CGFloat
};
```

**Correct Usage:**
```cpp
// ✅ CORRECT
TrueSheetViewEventEmitter::OnDragBegin event;
event.index = static_cast<int>(nsIntegerValue);
event.value = static_cast<double>(cgFloatValue);
emitter->onDragBegin(event);

// ❌ WRONG
event.index = static_cast<Int32>(nsIntegerValue);
event.value = static_cast<Float>(cgFloatValue);
```

---

## Common Pitfalls to Avoid

### 1. Don't Dereference WithDefault Types
```cpp
// ❌ This will not compile
UIColor *color = RCTUIColorFromSharedColor(SharedColor(*newViewProps.background));

// ✅ Do this instead
UIColor *color = RCTUIColorFromSharedColor(SharedColor(newViewProps.background));
```

### 2. Don't Use Custom Type Names for Events
```cpp
// ❌ These types don't exist
Int32, Float, Double (in event emitters)

// ✅ Use standard C++ types
int, double, float
```

### 3. Don't Add Manual Header Search Paths
```cpp
// ❌ Not needed if codegenConfig is correct
s.pod_target_xcconfig = {
    "HEADER_SEARCH_PATHS" => "\"${PODS_CONFIGURATION_BUILD_DIR}/ReactCodegen/...\""
}

// ✅ Let the build system handle it
s.pod_target_xcconfig = {
    "DEFINES_MODULE" => "YES"
}
```

---

## Testing the Fixes

### Verify Build
```bash
cd example/ios
rm -rf Pods Podfile.lock
pod install
cd ..
yarn ios
```

### Check for Errors
```bash
# Should see no errors
xcodebuild ... | grep "error:"

# Should see BUILD SUCCEEDED
xcodebuild ... | grep "BUILD SUCCEEDED"
```

### Verify Codegen Output
```bash
find example/ios/build/generated -name "*.h" -path "*TrueSheetViewSpec*"
```

---

## Lessons Learned

1. **WithDefault is a value type**, not an optional pointer
2. **Codegen uses standard C++ types** for events, not custom aliases
3. **codegenConfig structure matters** - wrong config = no generation
4. **Component provider field** is the modern way to configure Codegen
5. **Build system handles paths** when config is correct

---

## Future Considerations

### For Android Migration
- Similar patterns will apply
- Watch for JNI type conversions
- Codegen generates Java interfaces too

### For Maintenance
- Always check generated files first when debugging
- Don't assume type names match TypeScript exactly
- Let tooling handle header paths when possible

---

## Quick Reference

| Issue | Solution |
|-------|----------|
| Missing Promise types | Add `#import <React/RCTBridgeModule.h>` |
| Cannot dereference WithDefault | Use direct value access: `props.value` |
| Int32/Float not found | Use `int`/`double` instead |
| Codegen not generating | Fix codegenConfig with componentProvider |
| Header not found | Ensure Codegen runs, check build output |

---

## Support

If you encounter similar issues:

1. Check this document first
2. Review generated Codegen files
3. Verify codegenConfig in package.json
4. Check React Native version compatibility
5. Ensure New Architecture is enabled

---

*This document reflects the final working state of the Fabric migration.*
*All builds passing as of November 15, 2024.*